<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Stage 2</title>

<style>
body{
  margin:0; min-height:100vh; background:#0b0b0b; color:#fff;
  display:flex; flex-direction:column; align-items:center; justify-content:center;
  gap:18px; font-family:system-ui, sans-serif; text-align:center;
}
.button-area{
  width:100%; display:flex; flex-direction:column; align-items:center; gap:18px;
}
button{
  width:85%; max-width:420px; height:90px; font-size:26px;
  border-radius:22px; border:none; background:#333; color:#fff;
}
.hidden{ display:none; }

.hint{
  width:90%; max-width:420px;
  background: rgba(255,255,255,0.08);
  border: 1px solid rgba(255,255,255,0.12);
  border-radius: 18px;
  padding: 14px 16px;
  line-height: 1.5;
}
.hint-title{ font-weight:800; margin-bottom:8px; opacity:0.95; }
.hint-code{
  font-weight:900;
  font-size:26px;
  letter-spacing: 0.18em;
  word-break: break-all;
}

/* âœ… æ¬¡ã¸ï¼šå¼·ã‚ãƒã‚«ãƒã‚«ç™ºå…‰ï¼ˆå®šç¾©ã¯1ã¤ã ã‘ã«æ•´ç†ï¼‰ */
@keyframes glow{
  0% {
    box-shadow:
      0 0 6px rgba(255,255,255,0.35),
      0 0 18px rgba(255,255,255,0.45),
      0 0 36px rgba(255,255,255,0.25);
  }
  50% {
    box-shadow:
      0 0 24px rgba(255,255,255,0.95),
      0 0 52px rgba(255,255,255,0.75),
      0 0 110px rgba(255,255,255,0.55);
  }
  100% {
    box-shadow:
      0 0 10px rgba(255,255,255,0.45),
      0 0 28px rgba(255,255,255,0.55),
      0 0 56px rgba(255,255,255,0.35);
  }
}

#nextBtn{
  height:64px;
  font-size:22px;
  background:#333;
  color:#fff;
  border:1px solid rgba(255,255,255,0.25);
  animation: glow 0.55s ease-in-out infinite;
}

.video-wrap{ width:92%; max-width:520px; }
video{ width:100%; border-radius:16px; }
</style>
</head>

<body>

<div class="button-area">
  <button onclick="press('ã‚ªãƒ¼ã¡ã‚ƒã‚“')">ã‚ªãƒ¼ã¡ã‚ƒã‚“</button>
  <button onclick="press('ã‚³ã‚¦ãƒ¢ãƒ³')">ã‚³ã‚¦ãƒ¢ãƒ³</button>
  <button onclick="press('ã†ã‚“ã“ãƒ¼ã·')">ã†ã‚“ã“ãƒ¼ã·</button>
</div>

<div id="hint2" class="hint hidden">
  <div class="hint-title">ãƒ’ãƒ³ãƒˆ</div>
  <div class="hint-code" id="hint2Code"></div>
</div>

<button id="nextBtn" class="hidden" onclick="goNext()">æ¬¡ã¸</button>

<div class="video-wrap hidden" id="videoArea">
  <!-- âœ… iPhoneå¯¾ç­–ï¼šplaysinline -->
  <video id="video2" controls playsinline>
    <source src="v4qf8VXZdo8DEEZ6GrCbcRM2-BpZFTevYFME5_N-C7k.mp4" type="video/mp4">
  </video>
</div>

<script>
const VERSION = "20251226i";

// ---- AudioContext ----
let audioCtx;
function getCtx(){
  if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  if(audioCtx.state === "suspended") audioCtx.resume();
  return audioCtx;
}

// ---- èª­ã¿ä¸Šã’ ----
function speak(text){
  speechSynthesis.cancel();
  const u = new SpeechSynthesisUtterance(text);
  u.lang = "ja-JP";
  speechSynthesis.speak(u);
}

// ---- æˆåŠŸéŸ³ ----
function playSuccessSound(){
  const ctx = getCtx();
  const o1 = ctx.createOscillator();
  const o2 = ctx.createOscillator();
  const gain = ctx.createGain();

  o1.type = "triangle";
  o2.type = "sine";
  o1.frequency.value = 880;
  o2.frequency.value = 1320;

  gain.gain.setValueAtTime(0.001, ctx.currentTime);
  gain.gain.exponentialRampToValueAtTime(0.4, ctx.currentTime + 0.05);
  gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.8);

  o1.connect(gain); o2.connect(gain); gain.connect(ctx.destination);
  o1.start(); o2.start();
  o1.stop(ctx.currentTime + 0.8);
  o2.stop(ctx.currentTime + 0.8);
}

// ---- æ¬¡ã¸ã‚¿ãƒƒãƒ—éŸ³ ----
function playTapSound(){
  const ctx = getCtx();
  const osc = ctx.createOscillator();
  const gain = ctx.createGain();
  osc.type = "sine";
  osc.frequency.value = 1000;

  gain.gain.setValueAtTime(0.001, ctx.currentTime);
  gain.gain.exponentialRampToValueAtTime(0.18, ctx.currentTime + 0.01);
  gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.12);

  osc.connect(gain); gain.connect(ctx.destination);
  osc.start(); osc.stop(ctx.currentTime + 0.12);
}

// ---- æš—å·ï¼ˆé•·ã•7ï¼‰----
const correctCode = [
  'ã†ã‚“ã“ãƒ¼ã·','ã‚ªãƒ¼ã¡ã‚ƒã‚“','ã‚³ã‚¦ãƒ¢ãƒ³','ã†ã‚“ã“ãƒ¼ã·','ã‚ªãƒ¼ã¡ã‚ƒã‚“','ã†ã‚“ã“ãƒ¼ã·','ã‚³ã‚¦ãƒ¢ãƒ³'
];

let input = [];
const video = document.getElementById("video2");
const videoArea = document.getElementById("videoArea");
const nextBtn = document.getElementById("nextBtn");

// æ•°å­—åˆ—ãƒ’ãƒ³ãƒˆï¼ˆå†…éƒ¨å¯¾å¿œï¼‰
const map2 = { 'ã‚ªãƒ¼ã¡ã‚ƒã‚“': '1', 'ã‚³ã‚¦ãƒ¢ãƒ³': '2', 'ã†ã‚“ã“ãƒ¼ã·': '3' };
document.getElementById("hint2Code").textContent = correctCode.map(x => map2[x]).join('');

// ãƒ’ãƒ³ãƒˆå›æ•°
let pressCount = 0;
const hintShowAt = 7;
const hintElem = document.getElementById("hint2");

// âœ… å‹•ç”»éŸ³ãƒ–ãƒ¼ã‚¹ãƒˆï¼ˆã“ã“ãŒæœ¬å‘½ï¼‰
let videoSourceNode = null;
let videoGainNode = null;

function setupVideoBoost(){
  const ctx = getCtx();

  // iOSã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œä¸­ã«resumeãŒå¤§äº‹
  if (ctx.state === "suspended") ctx.resume();

  // MediaElementSourceã¯åŒã˜videoã§1å›ã—ã‹ä½œã‚Œãªã„ã®ã§ä½¿ã„å›ã™
  if (!videoSourceNode) {
    videoSourceNode = ctx.createMediaElementSource(video);
    videoGainNode = ctx.createGain();

    // ğŸ”Š ãƒ–ãƒ¼ã‚¹ãƒˆé‡ï¼ˆ2.2ã€œ3.0æ¨å¥¨ï¼‰
    videoGainNode.gain.value = 2.8;

    videoSourceNode.connect(videoGainNode);
    videoGainNode.connect(ctx.destination);
  }
}

function press(word){
  // âœ… ã¾ãšãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œã®ä¸­ã§AudioContextã‚’èµ·ã“ã—ã¦ãŠã
  getCtx();

  // âœ… ã¤ã„ã§ã«å‹•ç”»ãƒ–ãƒ¼ã‚¹ãƒˆå›è·¯ã‚‚ï¼ˆæŠ¼ã—ã¦ã‚‹æœ€ä¸­ã«æº–å‚™ã™ã‚‹ã¨å®‰å®šï¼‰
  setupVideoBoost();

  speak(word);

  pressCount++;
  if(pressCount >= hintShowAt) hintElem.classList.remove("hidden");

  input.push(word);
  if(input.length > correctCode.length) input.shift();

  if(JSON.stringify(input) === JSON.stringify(correctCode)){
    try{ playSuccessSound(); }catch(e){}

    nextBtn.classList.remove("hidden");
    videoArea.classList.remove("hidden");

    // iOSå‘ã‘ã®å®‰å…¨ç­–
    video.muted = false;
    video.volume = 1.0;     // ä¸€å¿œæœ€å¤§ï¼ˆåŠ¹ã‹ãªãã¦ã‚‚ãƒ–ãƒ¼ã‚¹ãƒˆãŒåŠ¹ãï¼‰
    video.currentTime = 0;

  setTimeout(()=> {
  video.play().then(()=>{
    // âœ… å†ç”Ÿé–‹å§‹å¾Œã«ãƒ•ãƒ«ç”»é¢è¦æ±‚
    requestVideoFullscreen(video);
  }).catch(()=>{});

  setTimeout(()=> video.volume = 1.0, 150);
}, 80);


    input = [];
  }
}

function goNext(){
  try{ playTapSound(); }catch(e){}
  setTimeout(()=> location.href = "final.html?v=" + VERSION, 180);
}
  function requestVideoFullscreen(v){
  // iPhone Safari ç”¨ï¼ˆéæ¨™æº–ï¼‰
  if (v.webkitEnterFullscreen) {
    try { v.webkitEnterFullscreen(); } catch(e) {}
    return;
  }
  // æ¨™æº–
  if (v.requestFullscreen) {
    try { v.requestFullscreen(); } catch(e) {}
  }
}

</script>

</body>
</html>
