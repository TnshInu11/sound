<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Stage 2</title>

<style>
body{
  margin:0; min-height:100vh; background:#0b0b0b; color:#fff;
  display:flex; flex-direction:column; align-items:center; justify-content:center;
  gap:18px; font-family:system-ui, sans-serif; text-align:center;
}
.button-area{
  width:100%; display:flex; flex-direction:column; align-items:center; gap:18px;
}
button{
  width:85%; max-width:420px; height:90px; font-size:26px;
  border-radius:22px; border:none; background:#333; color:#fff;
}
.hidden{ display:none; }

.hint{
  width:90%; max-width:420px;
  background: rgba(255,255,255,0.08);
  border: 1px solid rgba(255,255,255,0.12);
  border-radius: 18px;
  padding: 14px 16px;
  line-height: 1.5;
}
.hint-title{ font-weight:800; margin-bottom:8px; opacity:0.95; }
.hint-code{
  font-weight:900;
  font-size:26px;
  letter-spacing: 0.18em;
  word-break: break-all;
}

/* ✅ 次へ：ノーマル＋発光 */
#nextBtn{
  height:64px;
  font-size:22px;
  background:#333;
  color:#fff;
  border: 1px solid rgba(255,255,255,0.18);
  animation: glow 1.2s ease-in-out infinite alternate;
}

@keyframes glow{
  from { box-shadow: 0 0 6px rgba(255,255,255,0.20), 0 0 14px rgba(255,255,255,0.10); }
  to   { box-shadow: 0 0 14px rgba(255,255,255,0.55), 0 0 32px rgba(255,255,255,0.22); }
}

.video-wrap{ width:92%; max-width:520px; }
video{ width:100%; border-radius:16px; }
</style>
</head>

<body>

<div class="button-area">
  <button onclick="press('オーちゃん')">オーちゃん</button>
  <button onclick="press('コウモン')">コウモン</button>
  <button onclick="press('うんこーぷ')">うんこーぷ</button>
</div>

<div id="hint2" class="hint hidden">
  <div class="hint-title">ヒント</div>
  <div class="hint-code" id="hint2Code"></div>
</div>

<button id="nextBtn" class="hidden" onclick="goNext()">次へ</button>

<div class="video-wrap hidden" id="videoArea">
  <video id="video2" controls>
    <source src="v4qf8VXZdo8DEEZ6GrCbcRM2-BpZFTevYFME5_N-C7k.mp4" type="video/mp4">
  </video>
</div>

<script>
const VERSION = "20251226h";

let audioCtx;
function getCtx(){
  if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  if(audioCtx.state === "suspended") audioCtx.resume();
  return audioCtx;
}

function speak(text){
  speechSynthesis.cancel();
  const u = new SpeechSynthesisUtterance(text);
  u.lang = "ja-JP";
  speechSynthesis.speak(u);
}

function playSuccessSound(){
  const ctx = getCtx();
  const o1 = ctx.createOscillator();
  const o2 = ctx.createOscillator();
  const gain = ctx.createGain();

  o1.type = "triangle";
  o2.type = "sine";
  o1.frequency.value = 880;
  o2.frequency.value = 1320;

  gain.gain.setValueAtTime(0.001, ctx.currentTime);
  gain.gain.exponentialRampToValueAtTime(0.4, ctx.currentTime + 0.05);
  gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.8);

  o1.connect(gain); o2.connect(gain); gain.connect(ctx.destination);
  o1.start(); o2.start();
  o1.stop(ctx.currentTime + 0.8);
  o2.stop(ctx.currentTime + 0.8);
}

function playTapSound(){
  const ctx = getCtx();
  const osc = ctx.createOscillator();
  const gain = ctx.createGain();
  osc.type = "sine";
  osc.frequency.value = 1000;

  gain.gain.setValueAtTime(0.001, ctx.currentTime);
  gain.gain.exponentialRampToValueAtTime(0.18, ctx.currentTime + 0.01);
  gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.12);

  osc.connect(gain); gain.connect(ctx.destination);
  osc.start(); osc.stop(ctx.currentTime + 0.12);
}

// 暗号（長さ7）
const correctCode = [
  'うんこーぷ','オーちゃん','コウモン','うんこーぷ','オーちゃん','うんこーぷ','コウモン'
];

let input = [];
const video = document.getElementById("video2");
const videoArea = document.getElementById("videoArea");
const nextBtn = document.getElementById("nextBtn");

// 数字列ヒント（内部対応）
const map2 = { 'オーちゃん': '1', 'コウモン': '2', 'うんこーぷ': '3' };
document.getElementById("hint2Code").textContent =
  correctCode.map(x => map2[x]).join('');

// ヒント回数（そのまま：早め）
let pressCount = 0;
const hintShowAt = 7;
const hintElem = document.getElementById("hint2");

function press(word){
  getCtx();
  speak(word);

  pressCount++;
  if(pressCount >= hintShowAt) hintElem.classList.remove("hidden");

  input.push(word);
  if(input.length > correctCode.length) input.shift();

  if(JSON.stringify(input) === JSON.stringify(correctCode)){
    try{ playSuccessSound(); }catch(e){}
    nextBtn.classList.remove("hidden");
    videoArea.classList.remove("hidden");
    video.volume = 1.0;
    video.currentTime = 0;
    video.play();
    input = [];
  }
}

function goNext(){
  try{ playTapSound(); }catch(e){}
  setTimeout(()=> location.href = "final.html?v=" + VERSION, 180);
}
</script>

</body>
</html>
